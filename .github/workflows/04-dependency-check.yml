name: Dependency Audit - OWASP Dependency-Check 

on:
  push:
    branches: ["main", "**"]
  pull_request:
    branches: ["main", "**"]
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

jobs:
  dependency-check:
    name: Run OWASP Dependency-Check (SCA)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create output folder
        run: mkdir -p security

      - name: Run Dependency-Check (Marketplace Action)
        uses: dependency-check/Dependency-Check_Action@v3.2.1
        with:
          project: "ProjectSCGH"
          path: "."               
          format: "HTML,JSON"     
          out: "security"         
          args: >
            --enableExperimental
            --failOnCVSS 0
            --nvdApiKey ${{ secrets.NVD_API_KEY }}

      - name: Show generated files
        run: ls -lah security || echo "No report generated"

      - name: Upload Dependency-Check Reports
        uses: actions/upload-artifact@v4
        with:
          name: dependency-check-report
          path: security/

      - name: Fail job if vulnerabilities >= HIGH
        run: |
          JSON="security/dependency-check-report.json"

          if [ ! -f "$JSON" ]; then
            echo "::error:: No JSON report found. Dependency-Check may have failed."
            exit 1
          fi

          HIGH_COUNT=$(jq '.dependencies[].vulnerabilities[]? | select(.severity=="High" or .severity=="Critical")' "$JSON" | wc -l)

          echo "High/Critical vulnerabilities found: $HIGH_COUNT"

          if [ "$HIGH_COUNT" -gt 0 ]; then
            echo "::error:: High/Critical vulnerabilities detected!"
            exit 1
          else
            echo "No High/Critical vulnerabilities detected."
          fi
